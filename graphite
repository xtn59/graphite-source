#!/bin/python3

from tkinter import *
from tinytag import TinyTag
import tkinter as tk
from tkinter import filedialog
from decimal import Decimal
from mutagen import File
from PIL import Image, ImageTk
from pathlib import Path
import time, pygame, os, subprocess

pygame.init()
pygame.mixer.init()

home_path = Path.home()
app_path = home_path / '.config' / 'graphite'
config_path = app_path / 'graphite.conf'
send_notifs = 0

def read_settings():
	global send_notifs
	with open(config_path, 'r') as cfg:
		for line in cfg:
			if ':' not in line:
				continue
			key, value = line.split(':', 1)
			key = key.strip()
			value = value.strip()			

			if key == 'foreground':
				_standardfg = str(value)
			elif key == 'background':
				_standardbg = str(value)
			elif key == 'font':
				fonty2 = (str(value), 10)
			elif key == 'directory to choose music from':
				_music_user_directory = str(value)
			elif key == 'logo2 directory':
				_logo2_directory = value
			elif key == 'logo3 directory':
				_logo3_directory = value
			elif key == 'send notifs on song play':
				send_notifs = int(value)

	start_geo = "230x230"
	return _standardfg, _standardbg, fonty2, _music_user_directory, _logo2_directory, _logo3_directory, start_geo
_standardfg, _standardbg, fonty2, _music_user_directory, _logo2_directory, _logo3_directory, start_geo = read_settings()

gver = 'graphite [1.0]' # graphite version

global_volume = Decimal('1.00')
selected_song = None
paused = False
playing = False
hovering = False
song_raw_name = None
song_list = []						#song_list[0] will be the name of the first song, [1] the second, blah blah blah
current_index = 0					#the current song number, will use it for this ^^^
artist_name = None

window = Tk()						#sets window
window.geometry(str(start_geo))				#sets starting geometry
window.title('graphite')				#sets window title to graphite	
icon = PhotoImage(file=f'{_logo2_directory}')		#sets icon to graph_logo2.png from graphite-app folder. you can put your image here.	
window.iconphoto(True,icon)				#sets window logo to icon
window.config(background=_standardbg)			#sets window background to standard background, at the start it is 'white'
window.resizable(False,False)				#you cannot resize the window when this is uncommented.
hidden = 1

graph_logo = f'{_logo2_directory}'
coverty_w = 160  #150
coverty_x = 35 #37.5
coverty_h = 160  #150
coverty_y = 35   #50
coverty_label = Label(window,takefocus=0,bg=_standardbg)
coverty_label.place(x=coverty_x,y=coverty_y)
# load logo
coverty = Image.open(graph_logo)
coverty = coverty.resize((coverty_w, coverty_h), Image.Resampling.LANCZOS)
coverty = ImageTk.PhotoImage(coverty)
coverty_label.config(image=coverty)
coverty_label.image = coverty
coverty_path = None

def song_time():
	global selected_song, playing
	if selected_song:
		audio = File(selected_song)

		ntime = pygame.mixer.music.get_pos() / 1000
		elapsed = time.strftime('%M:%S', time.gmtime(ntime))
		ail = audio.info.length
		naudio = time.strftime('%M:%S', time.gmtime(ail))
		to_print = (elapsed + '/' + naudio)
		passed_label.config(text=to_print)
	window.after(80,song_time)
song_time()

dir_label = Label(window,text='file',font=fonty2,fg=_standardfg,cursor='hand2',bg=_standardbg)
play_button = Label(window,text='play/stop',font=fonty2,fg=_standardfg,cursor='hand2',bg=_standardbg)
vol_button = Label(window,text=str(global_volume),font=fonty2,fg=_standardfg,cursor='hand2',bg=_standardbg)
passed_label = Label(window,text='00:00/00:00',fg=_standardfg,bg=_standardbg,font=fonty2,cursor='hand2')	#text was previously ''
artist_label = Label(window,text='graphite',fg=_standardfg,bg=_standardbg,font=fonty2)
song_name = Label(window,fg=_standardfg,bg=_standardbg,text='',font=fonty2)

#llll = Label(window,text='|',font=fonty2)
#llll.place(x=240,y=250)

dir_label.place(x=0,y=215)
play_button.place(x=35,y=215)
vol_button.place(x=105,y=215)
passed_label.place(x=230,y=224,anchor='e')

song_name.place(x=0,y=0)
artist_label.place(x=0,y=13)

ttag = None

def get_files(button):
	global selected_song,song_list,current_index,hovering,paused,playing,artist_label,file_extension,song_raw_name,artist_name,song_path,app_path,coverty_w,coverty_h,_music_user_directory,coverty_path,send_notifs

	if button == 1:
		path = filedialog.askdirectory(initialdir=str({_music_user_directory}))	
	else:
		path = os.getcwd()

	if path:
		files = sorted([f for f in os.listdir(path) if f.endswith(('.mp3','.wav','.ogg','.flac','.aac','.m4a','.alac'))])
		files_covert = sorted([f for f in os.listdir(path) if f.lower().endswith(('cover.jpg','cover.png'))])
		if files:
			song_list = [os.path.join(path, f) for f in files]
			current_index = 0

			selected_song = song_list[current_index]
			song_raw_name, file_extension = os.path.splitext(os.path.basename(selected_song))
			pygame.mixer.music.stop()
			hovering = False
			paused = False
			current_index = 0
		else:
			song_list = []
			selected_song = None
			song_name.config(text='no audio :^(')
		if files_covert:
			covert_file = os.path.join(path, files_covert[0])
			coverty_path = str(covert_file)
			try:
				coverty = Image.open(covert_file)
				coverty = coverty.resize((coverty_w, coverty_h), Image.Resampling.LANCZOS)
				coverty = ImageTk.PhotoImage(coverty)

				coverty_label.config(image=coverty)
				coverty_label.image = coverty
			except Exception as e:
				pass
		else:
			coverty_path = f'{_logo2_directory}'
			coverty = Image.open(f'{_logo2_directory}')
			coverty = coverty.resize((coverty_w, coverty_h), Image.Resampling.LANCZOS)
			coverty = ImageTk.PhotoImage(coverty)

			coverty_label.config(image=coverty)
			coverty_label.image = coverty
	update_playing_info()

dir_label.bind('<Button-1>', lambda event: get_files(1))
window.bind('<Tab>', lambda event: get_files(1))
dir_label.bind('<Enter>', lambda event: dir_label.config(fg='grey'))
dir_label.bind('<Leave>', lambda event: dir_label.config(fg=_standardfg))

def play_this_song():
	global paused, playing, current_index, file_extension, song_raw_name, song_path, send_notifs, coverty_path

	if selected_song:
		pygame.mixer.music.load(selected_song)
		pygame.mixer.music.set_volume(float(global_volume))
		pygame.mixer.music.play()
		paused = False
		playing = True
		song_raw_name, file_extension = os.path.splitext(str(os.path.basename(selected_song)))
#		try:

		ttag = TinyTag.get(str(selected_song))
		artist_name = ttag.artist
		print(artist_name)
		print(song_raw_name)
		artist_label.config(text=str(artist_name.lower()))
		song_name.config(text=str(song_raw_name.lower()))

#		except Exception as e:
#			artist_name = None
#			artist_label.config(text='no artist')

	if send_notifs == 1:
		subprocess.run(["notify-send", f"{song_raw_name} - {artist_name}", "-i", coverty_path], shell=False)

def play_click(event=None):
	global selected_song, paused, playing, play_inf, artist_name

	if not selected_song:
		song_name.config(text='no audio selected :^(')
		return
	else:
		play_inf = 'playing'
		play_this_song()

def play_button_(event=None):
	global play_inf,song_name,paused,playing,artist_name
	if paused:
		play_inf = 'playing'
		pygame.mixer.music.unpause()
		play_button.config(fg=_standardfg)
		paused = False
		playing = True
	elif playing:
		play_inf = 'paused'
		pygame.mixer.music.pause()
		paused = True
		playing = False
	else:
		play_click()

def vol_click(event):
	global global_volume,vol_button

	if global_volume < Decimal('1.00'):
		global_volume += Decimal('0.05')

		pygame.mixer.music.set_volume(float(global_volume))
		vol_button.config(text=str(global_volume))

def vol_dec(event):
	global global_volume,vol_button

	if global_volume > Decimal('0.00'):
		global_volume -= Decimal('0.05')

		pygame.mixer.music.set_volume(float(global_volume))
		vol_button.config(text=str(global_volume))

def vol_scroll(event):
	if event.delta > 0:
		vol_click(event)
	else:
		vol_dec(event)

def skip_left_click(event):
	global global_volume,skip_left,current_index,selected_song
	if current_index - 1 >= 0:
		current_index -= 1
		selected_song = song_list[current_index]
		play_this_song()

def skip_left_enter(event):
	global hovering
	hovering = True
	skip_left.config(fg='grey')
def skip_left_leave(event):
	global hovering
	hovering = False
	skip_left.config(fg=_standardfg)

def skip_right_click(event):
	global global_volume,skip_right,current_index,selected_song
	if current_index + 1 < len(song_list):
		current_index += 1
		selected_song = song_list[current_index]
		play_this_song()

def skip_right_enter(event):
	global hovering
	hovering = True
	skip_right.config(fg='grey')
def skip_right_leave(event):
	global hovering
	hovering = False
	skip_right.config(fg=_standardfg)

def update_playing_info():
	global playing, paused, selected_song, current_index, song_list, hovering, play_inf, next_song1, next_song2, next_song3, next_song4, next_song5, playing_info, artist_name

	if playing:
		if pygame.mixer.music.get_busy():
			play_inf = 'playing'
		elif not paused and not hovering:
			if current_index + 1 < len(song_list):
				current_index += 1
				selected_song = song_list[current_index]
				play_this_song()
			else:
				playing = False
				paused = False
				play_inf = 'idle'

	if playing == True:
		play_inf = 'playing'
		play_button.config(text='stop')
	elif paused == True:
		play_inf = 'paused'
		play_button.config(text='play')
	elif paused == False and playing == False:
		play_inf = 'idle'
		play_button.config(text='play')

	window.after(100, update_playing_info)

def hide_ui():
	global hidden

	if hidden == 1:
		song_name.place(y=0)
		artist_label.place(y=13)
		hidden = 2
	elif hidden == 2:
		song_name.place(y=0)
		artist_label.place(y=1000)
		hidden = 3
	elif hidden == 3:
		song_name.place(y=1000)
		artist_label.place(y=0)
		hidden = 4
	elif hidden == 4:
		song_name.place(y=1000)
		artist_label.place(y=1000)
		hidden = 1

play_button.bind('<Button-1>',play_button_)
play_button.bind('<Enter>',lambda event: play_button.config(fg='grey'))
play_button.bind('<Leave>',lambda event: play_button.config(fg=_standardfg))
window.bind('<space>', play_button_)
vol_button.bind('<Button-4>', vol_click)
vol_button.bind('<Button-5>', vol_dec)
window.bind('<Up>', vol_click)
window.bind('<Down>', vol_dec)
window.bind('<Right>', skip_right_click)
window.bind('<Left>', skip_left_click)
vol_button.bind('<Enter>', lambda event: vol_button.config(fg='grey'))
vol_button.bind('<Leave>', lambda event: vol_button.config(fg=_standardfg))
passed_label.bind('<Enter>', lambda event: passed_label.config(fg='grey'))
passed_label.bind('<Leave>', lambda event: passed_label.config(fg=_standardfg))
window.bind('<KeyPress-g>', lambda event: hide_ui())

get_files(0)
update_playing_info()
window.mainloop()
